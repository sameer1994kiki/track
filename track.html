<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8" />
		<meta name="renderer" content="webkit" />
		<meta http-equiv="X-UA-Compatible" content="ie=edge" />
		<meta name="format-detection" content="address=no" />
		<meta name="format-detection" content="telephone=no" />
		<meta name="apple-touch-fullscreen" content="yes" />
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black" />
		<meta name="viewport" content="initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, user-scalable=no" />
		<link rel="shortcut icon" type="images/x-icon" href="data:image/ico;base64,aWNv" />
		<link rel="stylesheet" href="/ui-static-oss/static/antd.min.css" />
		<link rel="stylesheet" href="/ui-static-oss/static/reset.css" />
		<title>iPIN运营支撑系统</title>
		<script>
			window.__initModel__ = {{{initModel}}};
			window._api_="{{{api_url}}}"
		</script>
	</head>
	<body>
		<div id="app" style="height: 100%;overflow: visible;"></div>
		<script>
			console.log(">>>><<<<<");
			window.addEventListener("hashchange", () => {
				debugger;
			});
			window.addEventListener("pushState", () => {
				debugger;
			});
			window.addEventListener("popstate", () => {
				debugger;
			});
			window.addEventListener("visibilitychange", () => {
				debugger;
			});
			window.addEventListener("DOMContentLoaded", () => {
				debugger;
			});
			document.getElementsByTagName("body")[0].addEventListener("click", e => {
				const node = e.target;
				const { dataset } = node;
				const { track,trackextra } = dataset;
				if (node && node.nodeType === 1 && typeof node.onclick === "function" && track) {
					track.extra=trackextra;
					TcFnc(track)
				}
			});

			let trackEventList = [];
			const trackConfig = {
				version: "1.0",
				threshold: 4, //最大存储数量
				project: "wmzy-ui-common-services", //项目名称
				url: "https://collector.wmzy.com/log-collect/app-behavior-upload",
				priority: "url", //可选url，cookie。出现同样的数据，那个优先级更高，默认url
				extraBasic: { aaa: 666 },
				extraEvent: { bbb: 9999 },
				basicInfoKeysReg: /^_/, //匹配到的字符串变为空
				basicInfoKeys: [
					"user_id",
					"token",
					"senior_province_id",
					"senior_city_id",
					"senior_region_id",
					"senior_school_id",
					"score",
					"score_rank",
					"score_type",
					"score_batch",
					"score_diploma_id",
					"province_id",
					"wenli",
					"select_course",
					"rank",
					"device_id",
					"interface_v",
					"net_operators",
					"_appid",
					"_platform",
					"_deviceuid",
					"_channel",
					"_vcode",
					"_vname",
					"_brand",
					"_net_type",
					"_sys_version",
					// 抓包之外
					"appid",
					"course_ids",
					"sdk",
					"ua",
					"session_id",
					"diploma_id",
				],
			};
			function TcFnc(track) {
				track =
					typeof track === "string"
						? {
								name: track,
								extra: {},
								type: "click",
						  }
						: extend(
								{
									name: "",
									extra: {},
									type: "click",
								},
								track
						  );
				const { type = "click" } = track;
				if (type === "view") {
					// 这里延时执行是为了等待html中的trackPathname执行完以后再执行，否则会获取到错误的trackPathname
					setTimeout(saveTrackInfo(track), 1000);
				} else {
					saveTrackInfo(track);
				}
			}

			//转换／初始化埋点数据结构
			function getTrackEventList() {
				trackEventList = localStorage.getItem("trackEventList");
				trackEventList = JSON.parse(trackEventList);
				// 判断是否有初始值
				if (isArray(trackEventList)) {
					trackEventList = [];
				}
			}
			function saveTrackInfo(track) {
				window && window.sendEvent && sendEvent("新埋点统计表", name, JSON.stringify(extra));
				saveStrackData(track);
			}

			// 获取基础信息
			function getBasicInfo(track) {
				let basicArry = trackConfig.basicInfoKeys ? trackConfig.basicInfoKeys : [];
				const cookieParams = getCookieParams();
				const urlParams = getUrlParams();
				let basicInfo;
				if (trackConfig.priority === "cookie") {
					basicInfo = extend(urlParams, cookieParams);
				} else {
					basicInfo = extend(cookieParams, urlParams);
				}
				let newbBasicInfo = {};
				for (const item in basicInfo) {
					if (basicArry.indexOf(item) > -1) {
						const newItem = item.replace(trackConfig.basicInfoKeysReg, "");
						if (basicInfo[item] !== "" && basicInfo[item] !== "undefined") {
							newbBasicInfo = extend(newbBasicInfo, { [newItem]: basicInfo[item] });
						}
					}
				}
				if (trackConfig.extraBasic && isObject(trackConfig.extraBasic)) {
					newbBasicInfo = extend(newbBasicInfo, trackConfig.extraBasic);
				}
				// if (track.onlyExtraBasic === true) {
				// 	newbBasicInfo = track.extraBasic;
				// } else if (track.extraBasic && isObject(track.extraBasic)) {
				// 	newbBasicInfo = extend(newbBasicInfo, track.extraBasic);
				// }
				return newbBasicInfo;
			}

			// 获取事件信息
			function getEventInfo(track) {
				var { name, extra = {}, type = "click", event_category } = track;
				const client_time = new Date().getTime().toString(); //事件发生时间（毫秒）
				event_category = event_category || type; //事件类型（view\click）
				const title = document.title; //页面标题
				const location = window && window.trackPathname ? window.trackPathname : window.location.pathname; //当前页面
				let referer = localStorage.getItem("trackReferrer") || "no-page";
				const target = name; //点击事件的name
				const eventInfo = {
					client_time,
					event_category,
					referer,
					location,
					target,
					title,
					extra,
				};
				return eventInfo;
			}

			// 保存本次收集的埋点信息
			function saveStrackData(track) {
				getTrackEventList();
				// 一条新的埋点信息
				let eventInfo = getEventInfo(track);
				if (trackConfig.extraEvent && isObject(trackConfig.extraEvent)) {
					eventInfo = extend(eventInfo, trackConfig.extraEvent);
				}
				// if (track.extraEvent && isObject(track.extraEvent)) {
				// 	eventInfo = extend(eventInfo, track.extraEvent);
				// }
				trackEventList.push(eventInfo);
				localStorage.setItem("trackEventList", JSON.stringify(trackEventList));
				// 防止请求借口失败，那么下一次点击事件以后可以继续提交
				if (trackEventList.length >= trackConfig.threshold) {
					postTrackData(track);
				}
				if (trackEventList.length >= trackConfig.threshold * 2) {
					cleanTrackData();
				}
			}

			// 清除收集的信息
			function cleanTrackData() {
				trackEventList = [];
				localStorage.setItem("trackEventList", JSON.stringify([]));
			}

			// 上传数据
			function postTrackData(track) {
				var basic_info = getBasicInfo(track);
				basic_info.project = trackConfig.project;
				var trackData = {};
				trackData["basic_info"] = basic_info;
				trackData["event_list"] = trackEventList;
				trackData["version"] = trackConfig.version;
				// 请求数据是否可以压缩一下
				ajax(trackConfig.url, trackData, function() {
					// localStorage.setItem("trackList", JSON.stringify(trackList));
					cleanTrackData();
				});
			}

			// 对象合并
			function extend(target, obj) {
				if (obj) target = target || {};

				for (var key in obj) {
					if (obj.hasOwnProperty(key)) {
						if (obj[key] && obj[key].constructor === Object) {
							target[key] = extend(target[key], obj[key]);
						} else {
							target[key] = obj[key];
						}
					}
				}

				return target;
			}
			// 获取url上的参数
			function getUrlParams(params) {
				var search = location.search.length > 0 ? location.search.substring(1) : "";
				var searchArray = search.length > 0 ? search.split("&") : []; // 获取链接上已有的参数
				var searchObject = {};
				var obj = {};
				var i, l;

				for (i = 0, l = searchArray.length; i < l; i++) {
					var item = searchArray[i].split("=");
					searchObject[item[0]] = item[1];
				}

				obj = extend(obj, searchObject);

				return obj;
			}

			// 获取cookie中的参数
			function getCookieParams(params) {
				var cookie = document && document.cookie;
				var obj = {};
				var cookieObject = {};
				var i, l;

				if (!cookie || cookie === "") {
					return obj;
				}

				cookie = cookie.split("; ");

				for (i = 0, l = cookie.length; i < l; i++) {
					var item = cookie[i].split("=");
					cookieObject[item[0]] = item[1];
				}
				obj = extend(obj, cookieObject);
				return obj;
			}

			// ajax请求
			function ajax(url, data, callback) {
				var ajax = new XMLHttpRequest();
				ajax.onreadystatechange = function() {
					if (ajax.readyState == 4 && ajax.status == 200) {
						var msg = ajax.responseText;
						console.log(msg);
						callback();
					}
				};

				ajax.open("post", url);
				ajax.setRequestHeader("content-type", "application/json");
				ajax.send(JSON.stringify(data));
			}

			//是否对象
			function isObject(value) {
				return Object.prototype.toString.call(value) === "[object Object]";
			}

			// 是否是数组
			function isArray(value) {
				return Object.prototype.toString.call(value) !== "[object Array]";
			}
		</script>
	</body>
</html>
